{% extends "base.html" %}

{% block title %}Analytics - Polymarket Tracker{% endblock %}

{% block content %}
<div class="glass-card">
    <h1 style="background: linear-gradient(135deg, #ef4444, #dc2626); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 3em; margin-bottom: 10px; filter: drop-shadow(0 0 30px rgba(239, 68, 68, 0.6)); font-weight: 900; letter-spacing: -1px;">
        📊 ACTIONABLE INSIGHTS
    </h1>
    <p style="color: #9ca3af; font-size: 1.1em; font-weight: 600;">Data-driven predictions to guide your trades</p>
</div>

<!-- Key Insights -->
<div class="glass-card" style="background: rgba(220, 38, 38, 0.15); border-color: rgba(239, 68, 68, 0.4);">
    <div style="display: flex; align-items: center; gap: 20px;">
        <div style="font-size: 4em;">🎯</div>
        <div>
            <h3 style="background: linear-gradient(135deg, #fca5a5, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; font-size: 1.4em; font-weight: 900;">HOW TO USE THIS DATA</h3>
            <p style="color: #e5e7eb; margin-bottom: 8px;">• <strong>Market Sentiment:</strong> See where smart money is betting</p>
            <p style="color: #e5e7eb; margin-bottom: 8px;">• <strong>Trading Patterns:</strong> Identify trends before the crowd</p>
            <p style="color: #e5e7eb;">• <strong>Category Insights:</strong> Find emerging opportunities</p>
        </div>
    </div>
</div>

<!-- Market Sentiment -->
<div class="glass-card">
    <h2 style="background: linear-gradient(135deg, #ef4444, #991b1b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8em; font-weight: 900; margin-bottom: 20px;">📈 MARKET SENTIMENT (24H)</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">🟢</div>
            <div class="stat-label">Bullish Trades</div>
            <div class="stat-value" id="bullishTrades">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">🔴</div>
            <div class="stat-label">Bearish Trades</div>
            <div class="stat-value" id="bearishTrades">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">📊</div>
            <div class="stat-label">Overall Sentiment</div>
            <div class="stat-value" id="sentiment" style="font-size: 1.8em;">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">💪</div>
            <div class="stat-label">Confidence Level</div>
            <div class="stat-value" id="confidence">-</div>
        </div>
    </div>
</div>

<!-- Trading Signals -->
<div class="glass-card">
    <h2 style="background: linear-gradient(135deg, #ef4444, #991b1b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8em; font-weight: 900; margin-bottom: 20px;">🚨 TRADING SIGNALS</h2>
    <div id="signalsContent"></div>
</div>

<!-- Top Whale Traders -->
<div class="glass-card">
    <h2 style="background: linear-gradient(135deg, #ef4444, #991b1b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8em; font-weight: 900; margin-bottom: 20px;">🏆 TOP PERFORMERS (24H)</h2>
    <div id="topTradersLoading" style="text-align: center; padding: 40px; color: white;">
        <div class="spinner"></div>
        <p style="color: #9ca3af;">Analyzing traders...</p>
    </div>
    <div id="topTradersContent" style="display: none;"></div>
</div>

<!-- Market Categories Performance -->
<div class="glass-card">
    <h2 style="background: linear-gradient(135deg, #ef4444, #991b1b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8em; font-weight: 900; margin-bottom: 20px;">📂 CATEGORY PERFORMANCE</h2>
    <div id="categoriesContent"></div>
</div>

<!-- Trending Markets -->
<div class="glass-card">
    <h2 style="background: linear-gradient(135deg, #ef4444, #991b1b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8em; font-weight: 900; margin-bottom: 20px;">🔥 TRENDING MARKETS</h2>
    <div id="trendingContent"></div>
</div>

<div style="text-align: center; color: #6b7280; padding: 20px; font-size: 0.9em;">
    Auto-refresh every 60 seconds • Last updated: <span id="lastUpdated"></span>
</div>
{% endblock %}

{% block scripts %}
<script>
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }

    async function loadAnalytics() {
        try {
            // Load whale data
            const whaleResponse = await fetch('/api/whale-activity?limit=100');
            const whaleData = await whaleResponse.json();

            if (whaleData.success) {
                const whales = whaleData.whales;
                
                // Calculate sentiment
                const buyCount = whales.filter(w => w.side === 'BUY').length;
                const sellCount = whales.filter(w => w.side === 'SELL').length;
                const buyVolume = whales.filter(w => w.side === 'BUY').reduce((sum, w) => sum + w.value, 0);
                const sellVolume = whales.filter(w => w.side === 'SELL').reduce((sum, w) => sum + w.value, 0);
                
                document.getElementById('bullishTrades').textContent = buyCount;
                document.getElementById('bearishTrades').textContent = sellCount;
                
                const sentimentRatio = buyCount / (buyCount + sellCount);
                let sentimentText = 'NEUTRAL';
                let sentimentColor = '#9ca3af';
                if (sentimentRatio > 0.6) {
                    sentimentText = '🚀 BULLISH';
                    sentimentColor = '#10b981';
                } else if (sentimentRatio < 0.4) {
                    sentimentText = '📉 BEARISH';
                    sentimentColor = '#ef4444';
                }
                
                const sentimentEl = document.getElementById('sentiment');
                sentimentEl.textContent = sentimentText;
                sentimentEl.style.background = `linear-gradient(135deg, ${sentimentColor}, ${sentimentColor})`;
                sentimentEl.style.webkitBackgroundClip = 'text';
                sentimentEl.style.webkitTextFillColor = 'transparent';
                
                // Confidence based on volume
                const totalVolume = buyVolume + sellVolume;
                const volumeDiff = Math.abs(buyVolume - sellVolume);
                const confidence = ((volumeDiff / totalVolume) * 100).toFixed(0);
                document.getElementById('confidence').textContent = confidence + '%';

                // Generate signals
                generateSignals(whales, buyCount, sellCount, buyVolume, sellVolume);

                // Calculate top traders
                displayTopTraders(whales);
            }

            // Load market data for categories
            const marketsResponse = await fetch('/api/markets?limit=100');
            const marketsData = await marketsResponse.json();

            if (marketsData.success) {
                const markets = marketsData.markets;
                displayCategories(markets);
                displayTrending(markets);
            }

        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }

    function generateSignals(whales, buyCount, sellCount, buyVolume, sellVolume) {
        let signals = [];

        // Signal 1: Strong buying pressure
        if (buyCount > sellCount * 1.5) {
            signals.push({
                type: 'BULLISH',
                icon: '🟢',
                title: 'Strong Buying Pressure Detected',
                description: `${buyCount} buy orders vs ${sellCount} sell orders. Smart money is accumulating.`,
                action: 'Consider following whale buys in trending markets'
            });
        }

        // Signal 2: Heavy selling
        if (sellCount > buyCount * 1.5) {
            signals.push({
                type: 'BEARISH',
                icon: '🔴',
                title: 'Heavy Selling Activity',
                description: `${sellCount} sell orders vs ${buyCount} buy orders. Whales might be taking profits.`,
                action: 'Wait for better entry points or follow sell signals'
            });
        }

        // Signal 3: Large volume imbalance
        if (buyVolume > sellVolume * 2) {
            signals.push({
                type: 'OPPORTUNITY',
                icon: '💎',
                title: 'Massive Buy Volume',
                description: `${formatCurrency(buyVolume)} in buys vs ${formatCurrency(sellVolume)} in sells.`,
                action: 'High conviction buying - investigate top markets'
            });
        }

        // Signal 4: Balanced market
        if (Math.abs(buyCount - sellCount) < 5 && whales.length > 20) {
            signals.push({
                type: 'NEUTRAL',
                icon: '⚖️',
                title: 'Market in Equilibrium',
                description: 'Balanced buying and selling activity.',
                action: 'Wait for clear directional signal before trading'
            });
        }

        // Display signals
        let html = '<div style="display: grid; gap: 20px;">';
        signals.forEach(signal => {
            const borderColor = {
                'BULLISH': '#10b981',
                'BEARISH': '#ef4444',
                'OPPORTUNITY': '#fbbf24',
                'NEUTRAL': '#6b7280'
            }[signal.type];

            html += `
                <div style="background: rgba(30, 30, 30, 0.8); padding: 25px; border-radius: 15px; border: 2px solid ${borderColor}; box-shadow: 0 0 30px ${borderColor}40;">
                    <div style="display: flex; align-items: start; gap: 20px;">
                        <div style="font-size: 3em;">${signal.icon}</div>
                        <div style="flex: 1;">
                            <h3 style="color: ${borderColor}; font-size: 1.3em; font-weight: 900; margin-bottom: 10px; text-transform: uppercase;">${signal.title}</h3>
                            <p style="color: #e5e7eb; margin-bottom: 10px; font-size: 1.05em;">${signal.description}</p>
                            <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 10px; border-left: 4px solid #ef4444;">
                                <strong style="color: #ef4444;">ACTION:</strong> <span style="color: #e5e7eb;">${signal.action}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        if (signals.length === 0) {
            html += '<p style="text-align: center; color: #6b7280; padding: 40px;">Not enough data to generate signals yet. Check back soon!</p>';
        }

        html += '</div>';
        document.getElementById('signalsContent').innerHTML = html;
    }

    function displayTopTraders(whales) {
        const loading = document.getElementById('topTradersLoading');
        const content = document.getElementById('topTradersContent');

        const traderVolumes = {};
        whales.forEach(w => {
            if (!traderVolumes[w.trader]) {
                traderVolumes[w.trader] = { volume: 0, wallet: w.wallet, trades: 0, wins: 0 };
            }
            traderVolumes[w.trader].volume += w.value;
            traderVolumes[w.trader].trades += 1;
        });

        const sorted = Object.entries(traderVolumes).sort((a, b) => b[1].volume - a[1].volume).slice(0, 10);
        let html = '<div style="display: grid; gap: 15px;">';
        sorted.forEach(([trader, data], index) => {
            const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `#${index + 1}`;
            const avgTrade = data.volume / data.trades;
            
            html += `
                <div style="background: rgba(30, 30, 30, 0.8); padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(239, 68, 68, 0.3);">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="font-size: 2.5em; min-width: 60px;">${medal}</div>
                        <div>
                            <div style="color: #ef4444; font-weight: 800; font-size: 1.3em;">${trader}</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">${data.trades} trades • Avg ${formatCurrency(avgTrade)}</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2em; font-weight: 900;">${formatCurrency(data.volume)}</div>
                        <div style="color: #10b981; font-size: 0.85em; font-weight: 700;">↗ COPY THIS TRADER</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';

        loading.style.display = 'none';
        content.innerHTML = html;
        content.style.display = 'block';
    }

    function displayCategories(markets) {
        const categoryVolumes = {};
        const categoryMarkets = {};
        
        markets.forEach(market => {
            const cat = market.category || 'Other';
            if (!categoryVolumes[cat]) {
                categoryVolumes[cat] = 0;
                categoryMarkets[cat] = 0;
            }
            categoryVolumes[cat] += market.volume;
            categoryMarkets[cat] += 1;
        });

        const sorted = Object.entries(categoryVolumes).sort((a, b) => b[1] - a[1]);
        const total = sorted.reduce((sum, [_, vol]) => sum + vol, 0);

        let html = '<div style="display: grid; gap: 20px;">';
        sorted.forEach(([category, volume]) => {
            const percentage = ((volume / total) * 100).toFixed(1);
            const marketCount = categoryMarkets[category];
            const avgVolume = volume / marketCount;
            
            let signal = '';
            let signalColor = '#6b7280';
            if (percentage > 30) {
                signal = '🔥 HOT';
                signalColor = '#ef4444';
            } else if (avgVolume > 1000000) {
                signal = '💎 HIGH VALUE';
                signalColor = '#fbbf24';
            } else if (marketCount > 10) {
                signal = '📈 ACTIVE';
                signalColor = '#10b981';
            }

            html += `
                <div style="background: rgba(30, 30, 30, 0.8); padding: 20px; border-radius: 15px; border: 1px solid rgba(239, 68, 68, 0.2);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center;">
                        <div>
                            <span style="color: #ef4444; font-weight: 800; font-size: 1.3em;">${category}</span>
                            ${signal ? `<span style="background: ${signalColor}30; color: ${signalColor}; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 900; margin-left: 10px;">${signal}</span>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #fbbf24; font-weight: 900; font-size: 1.4em;">${formatCurrency(volume)}</div>
                            <div style="color: #9ca3af; font-size: 0.85em;">${marketCount} markets</div>
                        </div>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.1); height: 12px; border-radius: 6px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #ef4444, #dc2626); height: 100%; width: ${percentage}%; border-radius: 6px; transition: width 1s ease;"></div>
                    </div>
                    <div style="color: #9ca3af; font-size: 0.85em; margin-top: 8px;">${percentage}% of total volume • Avg ${formatCurrency(avgVolume)} per market</div>
                </div>
            `;
        });
        html += '</div>';

        document.getElementById('categoriesContent').innerHTML = html;
    }

    function displayTrending(markets) {
        const sorted = markets.sort((a, b) => b.volume - a.volume).slice(0, 5);

        let html = '<div style="display: grid; gap: 15px;">';
        sorted.forEach((market, index) => {
            html += `
                <div style="background: rgba(30, 30, 30, 0.8); padding: 20px; border-radius: 15px; border: 1px solid rgba(239, 68, 68, 0.3); display: flex; align-items: center; gap: 20px;">
                    <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; font-weight: 900; font-size: 1.5em; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
                        ${index + 1}
                    </div>
                    <div style="flex: 1;">
                        <div style="color: #e5e7eb; font-weight: 700; font-size: 1.1em; margin-bottom: 5px;">${market.title}</div>
                        <div style="display: flex; gap: 20px;">
                            <span style="color: #10b981;">💰 ${formatCurrency(market.volume)}</span>
                            <span style="color: #60a5fa;">💧 ${formatCurrency(market.liquidity)}</span>
                        </div>
                    </div>
                    <a href="https://polymarket.com/market/${market.slug}" target="_blank" class="btn">TRADE</a>
                </div>
            `;
        });
        html += '</div>';

        document.getElementById('trendingContent').innerHTML = html;
    }

    function updateLastUpdated() {
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
    }

    window.addEventListener('DOMContentLoaded', () => {
        loadAnalytics();
        updateLastUpdated();
        
        setInterval(() => {
            loadAnalytics();
            updateLastUpdated();
        }, 60000);
    });
</script>
{% endblock %}