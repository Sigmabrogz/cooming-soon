{% extends "base.html" %}

{% block title %}Trader Profile - Polymarket{% endblock %}

{% block content %}
<div class="glass-card">
    <button class="btn" onclick="window.history.back()" style="margin-bottom: 20px;">← Back to Traders</button>
    
    <div id="traderHeader" style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px;">
        <div style="flex: 1;">
            <h1 style="color: #ef4444; font-size: 2.5em; margin-bottom: 10px; font-weight: 900;" id="traderName">Loading...</h1>
            <p style="color: #9ca3af; font-family: monospace;" id="traderWallet">{{ wallet }}</p>
        </div>
        <div>
            <button class="btn" onclick="copyAddress()">📋 Copy Address</button>
        </div>
    </div>
</div>

<div id="loadingStats" style="text-align: center; padding: 50px;">
    <div class="spinner"></div>
    <p style="color: #9ca3af; margin-top: 20px;">Loading trader statistics...</p>
</div>

<div id="statsContainer" style="display: none;">
    <!-- Performance Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">💰</div>
            <div class="stat-label">Total Volume</div>
            <div class="stat-value" id="statVolume">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">🎯</div>
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="statWinRate">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">📈</div>
            <div class="stat-label">Total P&L</div>
            <div class="stat-value" id="statPnl">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">⚡</div>
            <div class="stat-label">ROI</div>
            <div class="stat-value" id="statRoi">-</div>
        </div>
    </div>

    <!-- Additional Stats -->
    <div class="glass-card">
        <h2 style="color: #ef4444; font-size: 1.8em; margin-bottom: 25px; font-weight: 800;">📊 Trading Statistics</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div>
                <div style="color: #9ca3af; margin-bottom: 5px;">Total Trades</div>
                <div style="color: #e5e7eb; font-size: 1.5em; font-weight: 700;" id="totalTrades">-</div>
            </div>
            <div>
                <div style="color: #9ca3af; margin-bottom: 5px;">Wins / Losses</div>
                <div style="color: #e5e7eb; font-size: 1.5em; font-weight: 700;" id="winsLosses">-</div>
            </div>
            <div>
                <div style="color: #9ca3af; margin-bottom: 5px;">Avg Trade Size</div>
                <div style="color: #e5e7eb; font-size: 1.5em; font-weight: 700;" id="avgTradeSize">-</div>
            </div>
            <div>
                <div style="color: #9ca3af; margin-bottom: 5px;">Markets Traded</div>
                <div style="color: #e5e7eb; font-size: 1.5em; font-weight: 700;" id="uniqueMarkets">-</div>
            </div>
            <div>
                <div style="color: #9ca3af; margin-bottom: 5px;">Best Trade</div>
                <div style="color: #10b981; font-size: 1.5em; font-weight: 700;" id="bestTrade">-</div>
            </div>
            <div>
                <div style="color: #9ca3af; margin-bottom: 5px;">Trader Tier</div>
                <div style="color: #ef4444; font-size: 1.5em; font-weight: 700;" id="traderTier">-</div>
            </div>
        </div>
    </div>

    <!-- Market Performance -->
    <div class="glass-card">
        <h2 style="color: #ef4444; font-size: 1.8em; margin-bottom: 25px; font-weight: 800;">🎯 Market Performance</h2>
        <div id="loadingMarkets" style="text-align: center; padding: 30px;">
            <div class="spinner"></div>
            <p style="color: #9ca3af; margin-top: 20px;">Loading market performance...</p>
        </div>
        <div id="marketsContainer" style="display: none;">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Market</th>
                            <th>Trades</th>
                            <th>Win Rate</th>
                            <th>P&L</th>
                            <th>Volume</th>
                        </tr>
                    </thead>
                    <tbody id="marketsTable"></tbody>
                </table>
            </div>
        </div>
        <div id="noMarkets" style="display: none; text-align: center; padding: 30px; color: #9ca3af;">
            No market performance data available yet.
        </div>
    </div>

    <!-- Copy Trading Section -->
    <div class="glass-card">
        <h2 style="color: #ef4444; font-size: 1.8em; margin-bottom: 15px; font-weight: 800;">🔄 Copy This Trader</h2>
        <p style="color: #9ca3af; margin-bottom: 20px;">
            Follow this trader's moves and automatically copy their trades. Perfect for learning from successful strategies!
        </p>
        <button class="btn" onclick="window.location.href='/copy-trading?trader={{ wallet }}'">
            Start Copy Trading →
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const walletAddress = "{{ wallet }}";
    
    async function loadTraderStats() {
        try {
            const response = await fetch(`/api/trader/stats/${walletAddress}?days=30`);
            const data = await response.json();
            
            if (data.success) {
                displayStats(data.stats);
                loadMarketPerformance();
            } else {
                showError('Failed to load trader statistics');
            }
        } catch (error) {
            console.error('Error loading stats:', error);
            showError('Error loading trader data');
        }
    }
    
    async function loadMarketPerformance() {
        const loadingEl = document.getElementById('loadingMarkets');
        const containerEl = document.getElementById('marketsContainer');
        const noMarketsEl = document.getElementById('noMarkets');
        
        try {
            const response = await fetch(`/api/trader/markets/${walletAddress}?limit=10`);
            const data = await response.json();
            
            if (data.success && data.markets && data.markets.length > 0) {
                displayMarkets(data.markets);
                containerEl.style.display = 'block';
            } else {
                noMarketsEl.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading markets:', error);
            noMarketsEl.style.display = 'block';
        } finally {
            loadingEl.style.display = 'none';
        }
    }
    
    function displayStats(stats) {
        // Update header
        document.getElementById('traderWallet').textContent = stats.wallet_address;
        
        // Update main stats
        document.getElementById('statVolume').textContent = `$${stats.total_volume.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        document.getElementById('statWinRate').textContent = `${stats.win_rate.toFixed(1)}%`;
        
        const pnlEl = document.getElementById('statPnl');
        pnlEl.textContent = `$${stats.total_pnl.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        pnlEl.style.color = stats.total_pnl >= 0 ? '#10b981' : '#ef4444';
        
        const roiEl = document.getElementById('statRoi');
        roiEl.textContent = `${stats.roi_percentage >= 0 ? '+' : ''}${stats.roi_percentage.toFixed(1)}%`;
        roiEl.style.color = stats.roi_percentage >= 0 ? '#10b981' : '#ef4444';
        
        // Update detailed stats
        document.getElementById('totalTrades').textContent = stats.total_trades;
        document.getElementById('winsLosses').textContent = `${stats.wins} / ${stats.losses}`;
        document.getElementById('avgTradeSize').textContent = `$${stats.avg_trade_size.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        document.getElementById('uniqueMarkets').textContent = stats.unique_markets;
        document.getElementById('bestTrade').textContent = `$${stats.best_trade.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('traderTier').textContent = stats.trader_tier;
        
        // Show stats container
        document.getElementById('loadingStats').style.display = 'none';
        document.getElementById('statsContainer').style.display = 'block';
    }
    
    function displayMarkets(markets) {
        const tbody = document.getElementById('marketsTable');
        tbody.innerHTML = '';
        
        markets.forEach(market => {
            const row = document.createElement('tr');
            
            const winRateColor = market.win_rate >= 70 ? '#10b981' : market.win_rate >= 50 ? '#f59e0b' : '#ef4444';
            const pnlColor = market.total_pnl >= 0 ? '#10b981' : '#ef4444';
            
            row.innerHTML = `
                <td>
                    <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${market.market_title}
                    </div>
                </td>
                <td>${market.trades}</td>
                <td><strong style="color: ${winRateColor}">${market.win_rate.toFixed(1)}%</strong></td>
                <td><strong style="color: ${pnlColor}">$${market.total_pnl.toLocaleString(undefined, {minimumFractionDigits: 2})}</strong></td>
                <td>$${market.volume.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    function showError(message) {
        document.getElementById('loadingStats').innerHTML = `
            <div style="text-align: center; padding: 50px; color: #ef4444;">
                <p style="font-size: 1.2em;">⚠️ ${message}</p>
            </div>
        `;
    }
    
    function copyAddress() {
        navigator.clipboard.writeText(walletAddress);
        alert('Wallet address copied to clipboard!');
    }
    
    // Load data on page load
    loadTraderStats();
</script>
{% endblock %}

