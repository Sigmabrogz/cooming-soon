{% extends "base.html" %}

{% block title %}Top Traders - Polymarket{% endblock %}

{% block content %}
<div class="glass-card">
    <h1 style="color: #ef4444; font-size: 2.5em; margin-bottom: 10px; font-weight: 900;">👥 Top Traders Leaderboard</h1>
    <p style="color: #9ca3af; font-size: 1.1em; margin-bottom: 30px;">
        Discover the most successful traders and learn from their strategies. Click on any trader to view detailed analytics.
    </p>
</div>

<div class="stats-grid" id="overallStats" style="display: none;">
    <div class="stat-card">
        <div class="stat-icon">📊</div>
        <div class="stat-label">Total Traders</div>
        <div class="stat-value" id="totalTraders">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">💰</div>
        <div class="stat-label">Combined Volume</div>
        <div class="stat-value" id="combinedVolume">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">🔥</div>
        <div class="stat-label">Total Trades</div>
        <div class="stat-value" id="totalTrades">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">🎯</div>
        <div class="stat-label">Active Markets</div>
        <div class="stat-value" id="activeMarkets">-</div>
    </div>
</div>

<div class="glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="color: #ef4444; font-size: 1.8em; font-weight: 800;">🏆 Top Traders</h2>
        <button class="btn" onclick="loadTraders()">🔄 Refresh</button>
    </div>
    
    <div id="loadingTraders" style="text-align: center; padding: 50px;">
        <div class="spinner"></div>
        <p style="color: #9ca3af; margin-top: 20px;">Loading top traders...</p>
    </div>
    
    <div id="tradersContainer" style="display: none;">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Trader</th>
                        <th>Total Volume</th>
                        <th>Trades</th>
                        <th>Markets</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tradersTable"></tbody>
            </table>
        </div>
    </div>
    
    <div id="noTradersFound" style="display: none; text-align: center; padding: 50px; color: #9ca3af;">
        <p style="font-size: 1.2em;">No traders found. Whale activity will be tracked as trades occur.</p>
    </div>
</div>

<div class="glass-card">
    <h2 style="color: #ef4444; font-size: 1.8em; margin-bottom: 15px; font-weight: 800;">💡 About Trader Rankings</h2>
    <div style="color: #e5e7eb; line-height: 1.8;">
        <p style="margin-bottom: 15px;">
            <strong style="color: #ef4444;">How Rankings Work:</strong> Traders are ranked based on their total trading volume from recent whale activity (trades over $10,000).
        </p>
        <p style="margin-bottom: 15px;">
            <strong style="color: #ef4444;">Trader Tiers:</strong>
        </p>
        <ul style="list-style-position: inside; padding-left: 20px;">
            <li>🐋 <strong>Whale</strong>: $1M+ volume, 70%+ win rate, 50%+ ROI</li>
            <li>💎 <strong>Expert</strong>: $100K+ volume, 60%+ win rate, 25%+ ROI</li>
            <li>📈 <strong>Advanced</strong>: $10K+ volume, 50%+ win rate, 10%+ ROI</li>
            <li>📊 <strong>Intermediate</strong>: $1K+ volume with positive performance</li>
            <li>🌱 <strong>Beginner</strong>: Starting traders</li>
        </ul>
        <p style="margin-top: 15px;">
            Click on any trader to see their detailed performance history, win rate, market breakdown, and more!
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadTraders() {
        const loadingEl = document.getElementById('loadingTraders');
        const containerEl = document.getElementById('tradersContainer');
        const noTradersEl = document.getElementById('noTradersFound');
        const statsEl = document.getElementById('overallStats');
        
        loadingEl.style.display = 'block';
        containerEl.style.display = 'none';
        noTradersEl.style.display = 'none';
        
        try {
            const response = await fetch('/api/traders/top');
            const data = await response.json();
            
            if (data.success && data.traders && data.traders.length > 0) {
                displayTraders(data.traders);
                displayStats(data.traders);
                containerEl.style.display = 'block';
                statsEl.style.display = 'grid';
            } else {
                noTradersEl.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading traders:', error);
            noTradersEl.style.display = 'block';
        } finally {
            loadingEl.style.display = 'none';
        }
    }
    
    function displayTraders(traders) {
        const tbody = document.getElementById('tradersTable');
        tbody.innerHTML = '';
        
        traders.forEach((trader, index) => {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.onclick = () => window.location.href = `/trader/${trader.wallet}`;
            
            const rankBadge = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `#${index + 1}`;
            
            row.innerHTML = `
                <td><strong style="font-size: 1.2em;">${rankBadge}</strong></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${trader.profile_image ? `<img src="${trader.profile_image}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #ef4444;" />` : ''}
                        <div>
                            <div style="font-weight: 700; color: #ef4444;">${trader.trader_name}</div>
                            <div style="font-size: 0.85em; color: #9ca3af;">${trader.wallet.substring(0, 6)}...${trader.wallet.substring(trader.wallet.length - 4)}</div>
                        </div>
                    </div>
                </td>
                <td><strong style="color: #10b981;">$${trader.total_volume.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                <td>${trader.trade_count}</td>
                <td>${trader.unique_markets}</td>
                <td><button class="btn" onclick="event.stopPropagation(); window.location.href='/trader/${trader.wallet}'">View Profile 📊</button></td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    function displayStats(traders) {
        const totalVolume = traders.reduce((sum, t) => sum + t.total_volume, 0);
        const totalTrades = traders.reduce((sum, t) => sum + t.trade_count, 0);
        const allMarkets = new Set();
        traders.forEach(t => {
            // We don't have individual markets here, so we'll estimate
            allMarkets.add(t.wallet);
        });
        
        document.getElementById('totalTraders').textContent = traders.length;
        document.getElementById('combinedVolume').textContent = `$${(totalVolume / 1000000).toFixed(2)}M`;
        document.getElementById('totalTrades').textContent = totalTrades;
        document.getElementById('activeMarkets').textContent = traders.reduce((sum, t) => sum + t.unique_markets, 0);
    }
    
    // Load traders on page load
    loadTraders();
    
    // Auto-refresh every 30 seconds
    setInterval(loadTraders, 30000);
</script>
{% endblock %}

